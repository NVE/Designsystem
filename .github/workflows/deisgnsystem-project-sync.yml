
name: Designsystem Project Sync

on:
  issues:
    types: [opened, edited, labeled, unlabeled, reopened]
  workflow_dispatch:

permissions:
  contents: read
  issues: write

env:
  # üîó Sett til riktig Organization Project (Project v2) URL
  PROJECT_URL: "https://github.com/orgs/NVE/projects/1"

  # Feltnavn slik de st√•r i Project (case-sensitive)
  PROJECT_STATUS_FIELD_NAME: "Status"
  FIGMA_FIELD_NAME: "Figma"
  # Scriptet leter etter f√∏rste felt som matcher en av disse
  DOC_FIELD_CANDIDATES: "VitePress,Dokumentasjon"

  # Mapping fra issue-labels -> Status-feltets verdier (single-select)
  MAP_STATUS_SYNCH: |
    status: ‚úÖ I synk=>I synk
    status: ‚úèÔ∏è Design-endring=>Design-endring
    status: üé® Kun i design=>Kun i design
    status: ‚è≥ I utvikling=>I utvikling
    status: üö´ Deprecated=>Deprecated

  # Hvilke labels identifiserer komponenter
  COMPONENT_LABEL_PREFIX: "nve-"

jobs:
  add-to-project:
    name: Add to Project if labeled with component
    runs-on: ubuntu-latest
    steps:
      - name: Check if any component label is present
        id: comp
        uses: actions/github-script@v7
        with:
          script: |
            const labels = (context.payload.issue?.labels || []).map(l => typeof l === 'string' ? l : l.name);
            const prefix = process.env.COMPONENT_LABEL_PREFIX;
            const match = labels.some(l => l?.startsWith(prefix));
            core.setOutput('matches', match ? 'true' : 'false');

      - name: Add current issue to project
        if: steps.comp.outputs.matches == 'true'
        uses: actions/add-to-project@v0.5.0
        with:
          project-url: ${{ env.PROJECT_URL }}
          github-token: ${{ secrets.PAT_TOKEN }}

  sync-fields:
    name: Sync Status + Figma + VitePress/Dokumentasjon
    runs-on: ubuntu-latest
    steps:
      - name: Update Project fields from issue labels & body
        uses: actions/github-script@v7
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        with:
          script: |
            try {
              const { graphql } = require('@octokit/graphql');
              const gql = graphql.defaults({ headers: { authorization: `token ${process.env.GH_TOKEN}` }});

              const PROJECT_URL = process.env.PROJECT_URL;
              const STATUS_FIELD_NAME = process.env.PROJECT_STATUS_FIELD_NAME;
              const FIGMA_FIELD_NAME = process.env.FIGMA_FIELD_NAME;
              const DOC_FIELD_CANDIDATES = process.env.DOC_FIELD_CANDIDATES.split(',').map(s=>s.trim());
              const map = Object.fromEntries(
                (process.env.MAP_STATUS_SYNCH || '')
                  .split('\n')
                  .filter(Boolean)
                  .map(line => line.split('=>').map(s => s.trim()))
              );

              const issue = context.payload.issue;
              if (!issue) { core.info('No issue payload'); return; }

              // 1) Finn √∏nsket Status-verdi ut fra labels
              const labels = issue.labels.map(l => typeof l === 'string' ? l : l.name);
              const statusLabel = Object.keys(map).find(k => labels.includes(k));
              const desiredStatus = statusLabel ? map[statusLabel] : null;

              // 2) Parse Figma- og VitePress-lenker fra issue-body
              const body = issue.body || '';

              // Regex-literals (ingen new RegExp)
              const rFigma = /^\s*Figma\s*:\s*(https?:\/\/\S+)/im;
              const rDoc   = /^\s*(VitePress|Dokumentasjon)\s*:\s*(https?:\/\/\S+)/im;
              const mF = body.match(rFigma);
              const mD = body.match(rDoc);

              let figmaUrl = mF ? mF[1].trim() : null;
              let docUrl   = mD ? mD[2].trim() : null;

              // Fallback via domenes√∏k
              if (!figmaUrl) {
                const dm = body.match(/https?:\/\/(?:www\.)?figma\.com\/\S+/i);
                if (dm) figmaUrl = dm[0];
              }
              if (!docUrl) {
                // Tilpass domenet under om dere bruker annet vertsnavn
                const dm = body.match(/https?:\/\/[A-Za-z0-9._-]*designsystem\.[A-Za-z0-9._-]+\/\S+/i);
                if (dm) docUrl = dm[0];
              }

              // 3) Parse org og project number fra URL
              const url = new URL(PROJECT_URL);
              // /orgs/<org>/projects/<number>
              const org = url.pathname.split('/')[2];
              const projectNumber = parseInt(url.pathname.split('/')[4], 10);

              // 4) Hent Project, felt og options
              const projRes = await gql(`
                query($org: String!, $number: Int!) {
                  organization(login: $org) {
                    projectV2(number: $number) {
                      id
                      fields(first: 100) {
                        nodes {
                          ... on ProjectV2FieldCommon { id name }
                          ... on ProjectV2SingleSelectField { id name options { id name } }
                          ... on ProjectV2Field { id name dataType }
                        }
                      }
                    }
                  }
                }
              `, { org, number: projectNumber });

              const project = projRes.organization?.projectV2;
              if (!project) { core.setFailed(`Project not found at ${PROJECT_URL}`); return; }

              // Finn felter
              const fields = project.fields.nodes;
              const statusField = fields.find(f => f.name === STATUS_FIELD_NAME && f.options);
              const figmaField  = fields.find(f => f.name === FIGMA_FIELD_NAME);
              const docField    = DOC_FIELD_CANDIDATES.map(n => fields.find(f => f.name === n)).find(Boolean);

              // Valider Status-opsjon om n√∏dvendig
              let statusOptionId = null;
              if (desiredStatus && statusField) {
                const opt = statusField.options.find(o => o.name === desiredStatus);
                if (!opt) { core.setFailed(`Status option '${desiredStatus}' not found`); return; }
                statusOptionId = opt.id;
              } else if (desiredStatus && !statusField) {
                core.setFailed(`Status field '${STATUS_FIELD_NAME}' not found or not single-select`);
                return;
              }

              // 5) Finn issue-id
              const issueNode = await gql(`
                query($owner:String!, $repo:String!, $number:Int!) {
                  repository(owner:$owner, name:$repo) {
                    issue(number:$number) { id }
                  }
                }
              `, { owner: context.repo.owner, repo: context.repo.repo, number: issue.number });
              const issueId = issueNode.repository.issue.id;

              // 6) S√∏rg for at issue er i prosjektet
              const itemsRes = await gql(`
                query($projectId:ID!) {
                  node(id:$projectId) {
                    ... on ProjectV2 {
                      items(first: 200) {
                        nodes { id content { ... on Issue { id number } } }
                      }
                    }
                  }
                }
              `, { projectId: project.id });

              let itemId = itemsRes.node.items.nodes.find(n => n.content?.id === issueId)?.id;
              if (!itemId) {
                const addRes = await gql(`
                  mutation($projectId:ID!, $contentId:ID!) {
                    addProjectV2ItemById(input:{projectId:$projectId, contentId:$contentId}) { item { id } }
                  }
